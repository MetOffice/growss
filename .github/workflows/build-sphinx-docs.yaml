# ------------------------------------------------------------------------------
#  (c) Crown copyright Met Office. All rights reserved.
#  The file LICENCE, distributed with this code, contains details of the terms
#  under which the code may be used.
# ------------------------------------------------------------------------------

name: Build Sphinx Docs

on:
  workflow_call:
    inputs:
      python-version:
        description: "The Python version to use"
        required: false
        type: string
        default: "3.14"
      docs-directory:
        description: "Directory containing the documentation source to build"
        required: false
        type: string
        default: "documentation"
      toml-file:
        description: "Path to the pyproject file to install dependencies from"
        required: true
        type: string
        default: "pyproject.toml"
      sphinx-opts:
        description: "Additional options to pass to the Sphinx build command"
        required: false
        type: string
        default: "-W --keep-going -n"
      build-directory:
        description: "Directory to output the html documentation to"
        required: false
        type: string
        default: "build"
      runner:
        description: "The runner to use for the job"
        required: false
        type: string
        default: "ubuntu-latest"
      timeout:
        description: "Timeout for the job in minutes"
        required: false
        type: number
        default: 5

jobs:
  build-sphinx-docs:
    name: Build Sphinx Docs
    runs-on: ${{ inputs.runner }}
    timeout-minutes: ${{ inputs.timeout }}
    env:
      DOCS_DIR: ${{ inputs.docs-directory }}
      TOML_FILE: ${{ inputs.toml-file }}
      SPHINX_OPTS: ${{ inputs.sphinx-opts }}
      BUILD_DIR: ${{ inputs.build-directory }}
      UV_CACHE_DIR: /tmp/.uv-cache

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ inputs.python-version }}
          enable-cache: true

      - name: restore uv cache
        uses: actions/cache@v4
        with:
          path: ${{ env.UV_CACHE_DIR }}
          key: ${{ runner.os }}-${{ hashFiles('uv.lock') }}
          restore-keys: |
            uv-${{ runner.os }}-${{ hashFiles('uv.lock') }}
            uv-${{ runner.os }}

      - name: Generate uv environment
        run: uv init

      - name: Install dependencies
        run: uv sync --project "$TOML_FILE"

      - name: Lint Sphinx docs
        working-directory: ${{ env.DOCS_DIR }}
        run: sphinx-lint .

      - name: Build Sphinx HTML docs
        working-directory: ${{ env.DOCS_DIR }}
        run: uv run make html SPHINXOPTS="$SPHINX_OPTS" BUILDDIR="$BUILD_DIR"

      - name: Upload artifact to GitHub Pages
        if: ${{ (github.event_name == 'push' || github.event_name == 'merge_group') && github.ref_name == 'main'}}
        uses: actions/upload-pages-artifact@v4
        with:
          name: github-pages
          path: "$BUILD_DIR/html"
          retention-days: 1

      - name: Minimize uv cache
        run: uv cache prune --ci
