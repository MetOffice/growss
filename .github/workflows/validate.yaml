# ------------------------------------------------------------------------------
# (c) Crown copyright Met Office. All rights reserved.
# The file LICENCE, distributed with this code, contains details of the terms
# under which the code may be used.
# ------------------------------------------------------------------------------

name: CI
# This workflow is used for validating code quality on growss PRs.

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

permissions: read-all

jobs:

  validate:
    name: ${{ matrix.check }}
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    strategy:
      fail-fast: false
      matrix:
        check: [yaml-lint, python-lint, python-format, shell-check]

    env:
      UV_CACHE_DIR: /tmp/.uv-cache
      UV_PYTHON: "3.14"

    steps:
      - uses: actions/checkout@v6

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ env.UV_PYTHON }}
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install dependencies
        run: uv sync --frozen

      - name: YAML Lint
        if: matrix.check == 'yaml-lint'
        run: uv run yamllint -s .

      - name: Python Lint
        if: matrix.check == 'python-lint'
        run: uv run ruff check --respect-gitignore .

      - name: Python Format Check
        if: matrix.check == 'python-format'
        run: uv run ruff format --check --diff -s --respect-gitignore .

      - name: Shell Check
        if: matrix.check == 'shell-check'
        shell: bash
        run: |
          mapfile -d '' potential_files < <(
            find . -type f \( -name "*.*sh" -o ! -name "*.*" \) \
            -not -path "*.git/*" -not -path "*.venv/*" -print0
          )
          if [ ${#potential_files[@]} -eq 0 ]; then
            echo "No shell scripts to check."
            exit 0
          fi
          printf "%s\0" "${potential_files[@]}" \
            | xargs -0 file | grep "shell script" | cut -d: -f1 \
            | xargs -r uv run shellcheck -S warning \
            && echo "All checks passed!"
        continue-on-error: true
